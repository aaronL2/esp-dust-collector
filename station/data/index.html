<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESP Dust Collector – Station</title>
  <style>
    :root {
      --bg: #0b0c0f;
      --card: #111318;
      --muted: #9aa3b2;
      --fg: #e6e9ef;
      --accent: #6ea8fe;
      --ok: #24c38e;
      --warn: #f59e0b;
      --err: #ef4444;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, #1a2233 0%, var(--bg) 50%), var(--bg);
      color: var(--fg); padding: 24px; line-height: 1.35;
    }
    .wrap { max-width: 900px; margin: 0 auto; }
    h1 { margin: 0 0 16px; font-size: 28px; font-weight: 700; letter-spacing: 0.2px; }
    .card { background: linear-gradient(180deg, #131622, #0e1016); border: 1px solid #1f2737; border-radius: var(--radius); box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .section { padding: 18px 20px; }
    .section + .section { border-top: 1px solid #1f2737; }

    .kv { display: grid; grid-template-columns: 160px 1fr auto; gap: 10px 16px; align-items: center; }
    .label { color: var(--muted); font-weight: 600; }
    .value { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; word-break: break-all; }
    .actions { text-align: right; }

    .row { display: contents; }

    .btn {
      appearance: none; border: 1px solid #2b3042; background: #182032; color: var(--fg);
      padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: transform .02s ease, background .2s ease;
    }
    .btn:hover { background: #1b2740; }
    .btn:active { transform: translateY(1px); }
    .btn-accent { border-color: #284a99; background: #183060; }
    .btn-accent:hover { background: #1c3a75; }

    .muted { color: var(--muted); }
    .footer { margin-top: 18px; color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Dust Collector – Station</h1>

    <div class="card">
      <div class="section">
        <div class="kv" id="info">
          <div class="row">
            <div class="label">Name</div>
            <div class="value" id="name">…</div>
            <div class="actions"></div>
          </div>
          <div class="row">
            <div class="label">mDNS</div>
            <div class="value" id="mdns">…</div>
            <div class="actions"></div>
          </div>
          <div class="row">
            <div class="label">IP</div>
            <div class="value" id="ip">…</div>
            <div class="actions"></div>
          </div>
          <div class="row">
            <div class="label">MAC</div>
            <div class="value" id="mac">…</div>
            <div class="actions"></div>
          </div>
          <div class="row">
            <div class="label">FW</div>
            <div class="value"><span id="fw">…</span></div>
            <div class="actions">
              <a class="btn btn-accent" href="/update">Update FW</a>
            </div>
          </div>
          <div class="row">
            <div class="label">Current</div>
            <div class="value" id="amps">…</div>
            <div class="actions"></div>
          </div>
        </div>
      </div>

      <div class="section">
        <form id="nameForm" class="kv" autocomplete="off">
          <div class="row">
            <div class="label">Change name</div>
            <div class="value">
              <input id="newName" type="text" placeholder="Enter new name" style="width:100%; padding:8px 10px; border-radius:8px; border:1px solid #2b3042; background:#0c1018; color:var(--fg);" />
              <div class="muted" style="margin-top:6px">(requires reboot)</div>
            </div>
            <div class="actions">
              <button class="btn" type="submit">Save</button>
            </div>
          </div>
        </form>
      </div>

      <div class="section">
        <div class="kv">
          <div class="row">
            <div class="label">Register</div>
            <div class="value">
              <button class="btn" id="registerBtn">Register with Base</button>
              <span id="regStatus" class="muted" style="margin-left:12px"></span>
            </div>
            <div class="actions"></div>
          </div>
        </div>
      </div>

      <div class="section">
        <button class="btn" id="rebootBtn">Reboot</button>
        <span id="statusMsg" class="muted" style="margin-left:12px"></span>
      </div>
    </div>

    <div class="footer">UI v1 – unified styles for Base/Station</div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function loadStatus() {
      fetch('/status', { cache: 'no-store' })
        .then(r => r.json())
        .then(d => {
          $('name').textContent = d.name || '';
          $('ip').textContent = d.ip || '';
          $('mdns').textContent = d.mdns || '';
          $('mac').textContent = d.mac || '';
          $('fw').textContent = d.fw || '';
          $('amps').textContent = (d.amps !== undefined ? (Number(d.amps).toFixed(2) + ' A') : '');
        })
        .catch(() => {
          fetch('/info', { cache: 'no-store' })
            .then(r => r.json())
            .then(d => {
              $('name').textContent = d.name || '';
              $('ip').textContent = d.ip || '';
              $('mdns').textContent = d.mdns || '';
              $('mac').textContent = d.mac || '';
              $('fw').textContent = '(unknown)';
              $('amps').textContent = '(unknown)';
            });
        });
    }

    function hookNameForm() {
      $('nameForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const newName = $('newName').value.trim();
        if (!newName) return;
        fetch('/set-name', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: newName })
        })
        .then(r => r.json())
        .then(d => {
          $('statusMsg').textContent = 'Rebooting…';
          setTimeout(() => { window.location.href = d.newMdns || '/'; }, 3500);
        })
        .catch(() => $('statusMsg').textContent = 'Error saving name');
      });
    }

    function hookRegister() {
      $('registerBtn').addEventListener('click', () => {
        $('regStatus').textContent = 'Registering…';
        fetch('/register-with-base', { method: 'POST' })
          .then(async r => {
            const t = await r.text();
            $('regStatus').textContent = t || (r.ok ? 'Registered' : 'Registration failed');
          })
                    .catch(() => $('regStatus').textContent = 'Error registering');
      });
    }

    function hookReboot() {
      $('rebootBtn').addEventListener('click', () => {
        if (!confirm('Reboot device now?')) return;
        $('statusMsg').textContent = 'Rebooting…';
        fetch('/reboot', { method: 'POST' })
          .catch(() => {})
          .finally(() => setTimeout(() => location.reload(), 4000));
      });
    }

    loadStatus();
    setInterval(loadStatus, 1000);
    hookNameForm();
    hookRegister();
    hookReboot();
  </script>
</body>
</html>
